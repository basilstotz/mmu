#!/bin/bash

if test -z "$1";then
   echo "usage: $(basename "$0") <file>.csv"
   exit 1
fi
if ! test -f "$1";then
   echo "error: file \"$1\" does not exist"
   exit 1
fi

exists(){
    getent passwd | grep -q "^$1:.*"
    return $? 
}


ERR="false"

while IFS="," read -r uid passwd name type group; do
    if test -n "$uid"; then
	if [[ "$type" =~ ^(admin|teacher|student)$ ]]; then
	    if [[ "$passwd" =~ ^.{4,16}$ ]]; then
		if ! [[ "$uid" =~ ^[abcdefghijklmnopqrstuvwxyz_][abcdefghijklmnopqrstuvwxyz0123456789._]{0,31}$ ]]; then 
		    echo "error: username \"$uid\" is not allowed" >&2
		    ERR="true"
		fi
	    else
		echo "error: $uid"
		ERR="true"
	    fi
	else
	    echo "error: $uid type not correct"
	    ERR=true
	fi
    else
	echo "error: userid kan not be empty"
	ERR=true
    fi
done < "$1"

echo " ">alle.txt
getent passwd | while IFS=":" read -r uider passwd nuid rest; do
    if test $nuid -ge 1001 -a $nuid -lt 5000;then
	#echo $nuid $uider
	echo "$uider">>alle.txt
    fi
done

if test $ERR = "false"; then
    echo "info: input file ok"

    PFAD="/var/ltsp/users/"
    if ! test -d $PFAD; then
	mkdir -p $PFAD
	chmod 700 $PFAD
    fi

    echo -n "" > newusers.cmd
    
    
    while IFS="," read -r uid passwd name type group; do
       LINE="$uid:$passwd:::$name,$type,$group:/home/$uid:/usr/bin/bash"
       if ! exists "$uid";then
	   echo  "$LINE" >> newusers.cmd
	   echo "$LINE" > $PFAD/$uid
	   echo "      create $uid"
       else
	   if test -f  $PFAD/$uid; then
	       LINE_ALT=$(cat  $PFAD/$uid)
	   else
	       LINE_ALT=""
	   fi
	   if ! test "$LINE" = "$LINE_ALT"; then
	       echo "$LINE" >> newusers.cmd
	       echo "$LINE" >  $PFAD/$uid
	       echo "      modify $uid"
#	   else
#	       echo "             $uid"
	   fi
	   
       fi
 
     done < "$1"

     if newusers newusers.cmd;then
        echo "info: alles ok"
	rm newusers.cmd
     else
	echo "error: nummer $?"
     fi
	
	   
	   

    
    
else
    echo 
    echo "error: es gab fehler in den namen" >&2
fi


#uhu:Gaga2::::/home/uhu:/usr/bin/bash
#miau:kaTze::::/home/miau:/usr/bin/bash
